<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Trang cá nhân</title>
    <link rel="stylesheet" th:href="@{/assets/css/vendor.min.css}">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&amp;display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/assets/vendor/icon-set/style.css}">
    <link rel="stylesheet" th:href="@{/assets/css/theme.min.css?v=1.0}">

</head>

<body>
    <div th:replace="fragments/buildertoggle"></div>
    <div th:replace="fragments/headerMain"></div>
    <div id="headerFluid" class="d-none">
        <header id="header"
            class="navbar navbar-expand-xl navbar-fixed navbar-height navbar-flush navbar-container navbar-bordered  ">
            <div class="js-mega-menu navbar-nav-wrap">
                <div class="navbar-brand-wrapper">
                    <a class="navbar-brand" th:href="@{/}" aria-label="Front">
                        <img class="navbar-brand-logo" th:src="@{/assets/svg/logos/logo.svg}" alt="Logo">
                    </a>
                </div>
            </div>
        </header>
    </div>
    <div id="headerDouble" class="d-none">
        <header id="header" class="navbar navbar-expand-lg navbar-bordered flex-lg-column px-0">
        </header>
    </div>
    <div th:replace="fragments/sidebarMain"></div>
    <div id="sidebarCompact" class="d-none">
        <aside
            class="js-navbar-vertical-aside navbar navbar-vertical-aside navbar-vertical navbar-vertical-fixed navbar-expand-xl navbar-bordered  ">
            <div class="navbar-vertical-container">
                <div class="navbar-vertical-content">
                </div>
            </div>
        </aside>
    </div>

    <div th:replace="fragments/searchDropdown"></div>
    <div id="content" role="main" class="main pointer-event">
        <div class="content container-fluid">
            <div class="row justify-content-lg-center">
                <div class="col-lg-10">
                    <div class="profile-cover">
                        <div class="profile-cover-img-wrapper">
                            <img id="profileCoverImg" class="profile-cover-img" src="/assets/img/1920x400/img2.jpg"
                                alt="Image Description">

                            <div class="profile-cover-content profile-cover-btn">
                                <div class="custom-file-btn">

                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="text-center mb-5">
                        <label
                            class="avatar avatar-xxl avatar-circle avatar-border-lg avatar-uploader profile-cover-avatar"
                            for="avatarUploader" id="avatarLabel">
                            <img id="avatarImgInput" class="avatar-img" src="assets\img\160x160\img6.jpg"
                                alt="Image Description">

                        </label>
                        <h1 class="page-header-title ">
                            <span class="userNameInputs">Mark Williams</span>
                        </h1>



                        <ul class="list-inline list-inline-m-1" id="userDetails">
                            <li class="list-inline-item">
                                <i class="tio-city mr-1"></i>
                                <span class="company">Pixeel Ltd.</span>
                            </li>

                            <li class="list-inline-item">
                                <i class="tio-poi-outlined mr-1"></i>
                                <a href="#" id="city">Ha Noi,</a>
                                <a href="#" id="country">VN</a>
                            </li>

                            <li class="list-inline-item">
                                <i class="tio-date-range mr-1"></i>
                                <span class="joinDateClass">Joined March 2013</span>
                            </li>
                        </ul>
                        <!-- End List -->
                    </div>

                    <div class="js-nav-scroller hs-nav-scroller-horizontal mb-5" data-hs-nav-scroller-options='{
                       "type": "horizontal",
                       "delay": 20
                     }'>

                        <span class="hs-nav-scroller-arrow-backward" style="display: none;">
                            <a class="hs-nav-scroller-arrow-link" href="javascript:;">
                                <i class="tio-chevron-left"></i>
                            </a>
                        </span>

                        <span class="hs-nav-scroller-arrow-forward" style="display: none;">
                            <a class="hs-nav-scroller-arrow-link" href="javascript:;">
                                <i class="tio-chevron-right"></i>
                            </a>
                        </span>


                    </div>

                    <div class="row">
                        <div class="col-lg-4">
                            <div class="card card-body mb-3 mb-lg-5">
                                <h5>Hoàn thành hồ sơ của bạn</h5>

                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="progress flex-grow-1">
                                        <div class="progress-bar bg-primary" role="progressbar" style="width: 15%"
                                            aria-valuenow="15" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                    <span class="ml-4">15%</span>
                                </div>
                            </div>
                            <div class="card mb-3 mb-lg-5">
                                <div class="card-header">
                                    <h2 class="card-header-title h5">Hồ sơ</h2>

                                    <a class="btn btn-sm btn-white" th:href="@{/web-server/edit-profile}">Chỉnh sửa</a>
                                </div>
                                <div class="card-body">
                                    <ul class="list-unstyled list-unstyled-py-3 text-dark mb-3">
                                        <li class="py-0">
                                            <small class="card-subtitle">Giới thiệu</small>
                                        </li>

                                        <li>
                                            <i class="tio-user-outlined nav-icon"></i>
                                            <span class="userNameInputs">Mark Williams</span>
                                        </li>
                                        <li>
                                            <i class="tio-city nav-icon"></i>
                                            <span class="company">Pixeel Ltd.</span>
                                        </li>
                                        <li class="list-inline-item">
                                            <i class="tio-date-range mr-1"></i>
                                            <span class="joinDateClass">Tham gia vào tháng 3, 2013</span>
                                        </li>

                                        <li class="pt-2 pb-0">
                                            <small class="card-subtitle">Liên lạc</small>
                                        </li>

                                        <li>
                                            <i class="tio-online nav-icon"></i>
                                            <span id="emailInput">mark@example.com</span>
                                        </li>
                                        <li>
                                            <i class="tio-android-phone-vs nav-icon"></i>
                                            <span id="phoneInput">+1 (555) 752-01-10</span>
                                        </li>

                                        <li class="pt-2 pb-0">
                                            <small class="card-subtitle">Nhóm</small>
                                        </li>

                                        <li class="font-size-sm text-body">
                                            <i class="tio-group-equal nav-icon"></i>
                                            <span id="joinedGroupCount">0</span>
                                        </li>
                                        <li class="font-size-sm text-body">
                                            <i class="tio-briefcase-outlined nav-icon"></i>
                                            <span id="createdGroupCount">0</span>
                                        </li>
                                    </ul>

                                </div>
                            </div>

                        </div>

                        <div class="col-lg-8">
                            <div class="card mb-3 mb-lg-5">
                                <div class="card-header">
                                    <h2 class="card-header-title h5">Dòng hoạt động</h2>
                                </div>
                                <div class="card-body">
                                    <div id="postTableContainer" class="table-responsive">
                                    </div>
                                    <div id="noDataMessage" class="card-body card-body-height card-body-centered"
                                        style="display: none;">
                                        <img class="avatar avatar-xxl mb-3" src="/assets/svg/illustrations/yelling.svg"
                                            alt="Hình mô tả">
                                        <p class="card-text">Không có dữ liệu để hiển thị</p>
                                    </div>
                                </div>

                            </div>

                            <div class="card mb-3 mb-lg-5">
                                <div class="card-header">
                                    <h2 class="card-header-title h5">Nhóm đã tạo</h2>
                                </div>

                                <div class="card-body card-body-height card-body-centered">
                                    <div id="noDataMessage2" class="card-body card-body-height card-body-centered"
                                        style="display: none;">
                                        <img class="avatar avatar-xxl mb-3" src="/assets/svg/illustrations/yelling.svg"
                                            alt="Hình mô tả">
                                        <p class="card-text">Không có dữ liệu để hiển thị</p>
                                    </div>

                                    <div id="createdTableContainer" class="table-responsive">
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>

                </div>
            </div>
        </div>
        <div th:replace="fragments/notification"></div>


    </div>
    <script th:src="@{/assets/js/demo.js}"></script>
    <script th:src="@{/assets/js/vendor.min.js}"></script>
    <script th:src="@{/assets/js/theme.min.js}"></script>
    <!-- <script th:src="@{/assets/js/userjs.js}"></script> -->
    <script>
        $(document).on('ready', function () {
            $('.js-navbar-vertical-aside-toggle-invoker').click(function () {
                $('.js-navbar-vertical-aside-toggle-invoker i').tooltip('hide');
            });
            var megaMenu = new HSMegaMenu($('.js-mega-menu'), {
                desktop: {
                    position: 'left'
                }
            }).init();
            var sidebar = $('.js-navbar-vertical-aside').hsSideNav();
            $('.js-nav-tooltip-link').tooltip({ boundary: 'window' });
            $(".js-nav-tooltip-link").on("show.bs.tooltip", function (e) {
                if (!$("body").hasClass("navbar-vertical-aside-mini-mode")) {
                    return false;
                }
            });
        });
        $('.js-hs-unfold-invoker').each(function () {
            var unfold = new HSUnfold($(this)).init();
        });

        document.getElementById("logoutLink").addEventListener("click", function () {
            window.location.href("/web-server/login");
        });
        var token = localStorage.getItem("authToken");



        function isTokenExpired(token) {
            if (!token) return true;

            const payloadBase64 = token.split('.')[1];
            const decodedPayload = JSON.parse(atob(payloadBase64));

            const expirationTime = decodedPayload.exp;

            const expirationDate = new Date(expirationTime * 1000); // Corrected declaration


            const currentTime = Math.floor(Date.now() / 1000);
            return expirationTime < currentTime;
        }

        if (isTokenExpired(token)) {
            showModal('warning', 'Hết phiên đăng nhập', 'Phiên đăng nhập của bạn đã hết hạn. Vui lòng đăng nhập lại.');
            setTimeout(() => {
                window.location.href = '/web-server/login';
            }, 1000);
        }
        document.addEventListener("DOMContentLoaded", function () {
            var postTableContainer = document.getElementById('postTableContainer');
            var noDataMessage = document.getElementById('noDataMessage');


            var userID = localStorage.getItem("user_id");

            fetch(`http://localhost:8080/api/posts/user-create/${userID}?page=0&size=100`, {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                }
            })
                .then(response => response.json())
                .then(data => {
                    console.log(data);

                    function logPostId(event) {
                        const postId = event.target.getAttribute("data-id");
                        console.log(postId);


                        localStorage.setItem('selectedPostId', postId);
                        window.location.href = '/web-server/posts';
                    }

                    if (data.content && data.content.length > 0) {
                        var table = document.createElement('table');
                        table.classList.add('table', 'table-hover');
                        table.innerHTML = `
                <thead>
                    <tr>
                        <th class="text-center">#</th>
                        <th class="text-center">Content</th>
                        <th class="text-center">Trạng thái</th>
                        <th class="text-center">Hành động</th>
                    </tr>
                </thead>
                <tbody>
                    ${data.content.map((post, index) => {
                            const status = post.delflag == 0 ? 'Đang hoạt động' : 'Ngừng hoạt động';

                            const mediaUrl = post.mediaUrls && post.mediaUrls.length > 0 ? post.mediaUrls[0].mediaUrl : '';

                            const content = mediaUrl ? `
                            <div class="d-flex align-items-center">
                                <img src="${mediaUrl}" alt="Media" style="max-width: 50px; max-height: 50px; margin-right: 10px;"/>
                                <span>${post.postContent}</span>
                            </div>
                        ` : post.postContent;

                            return `
                            <tr>
                                <td class="text-center">${index + 1}</td> <!-- Hiển thị số thứ tự và căn giữa -->
                                <td class="text-center">${content}</td> <!-- Hiển thị nội dung bài đăng và căn giữa -->
                                <td class="text-center ${post.delflag == 0 ? 'text-success' : 'text-danger'}">${status}</td> <!-- Hiển thị trạng thái và căn giữa -->
                                <td class="text-center">
                                    <button class="btn btn-info btn-sm" data-id="${post.postId}">Chi Tiết</button>
                                </td>
                            </tr>
                        `;
                        }).join('')}
                </tbody>
            `;
                        postTableContainer.appendChild(table);

                        const buttons = document.querySelectorAll('.btn-info');
                        buttons.forEach(button => {
                            button.addEventListener('click', logPostId);
                        });

                        noDataMessage.style.display = 'none';
                    } else {
                        noDataMessage.style.display = 'flex';
                    }
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                    noDataMessage.style.display = 'flex';
                    noDataMessage.querySelector('.card-text').textContent = 'Không thể tải dữ liệu.';
                });
        });



        document.addEventListener("DOMContentLoaded", function () {
            var noDataMessage = document.getElementById('noDataMessage2');
            var groupTable = document.getElementById('created-groups-table'); // Bảng nhóm

            // Token và userID lấy từ localStorage
            var userID = localStorage.getItem("user_id");

            userCreatedGroups(userID);

            function getGroupDetails(groupId) {
                const url = `http://localhost:8080/api/groups/${groupId}`;

                return fetch(url, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${token}` }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status && data.data) {
                            return {
                                group_name: data.data.group_name || 'Không có',
                                admin_name: data.data.admin_name || 'Không có',
                                member_count: data.data.member_count || 0
                            };
                        }
                        return null;
                    })
                    .catch(error => {
                        console.error("Lỗi khi lấy thông tin nhóm:", error);
                        return null;
                    });
            }

            function userCreatedGroups(userId) {
                const url = `http://localhost:8080/api/member/user-create-id/${userId}`;
                const createdTableContainer = document.getElementById('createdTableContainer');

                fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        console.log("hihi", data); // In ra dữ liệu API để kiểm tra


                        if (data.data && data.data.length > 0) {
                            // Lấy chi tiết nhóm cho từng groupId
                            const groupDetailsPromises = data.data.map(groupId => getGroupDetails(groupId));

                            Promise.all(groupDetailsPromises)
                                .then(groupDetails => {

                                    createdTableContainer.innerHTML = ''; // Xóa danh sách cũ

                                    const table = document.createElement('table');
                                    table.classList.add('table', 'table-hover', 'mt-3');
                                    table.innerHTML = `
                        <thead>
                            <tr>
                                <th class="text-center">#</th>
                                <th class="text-start">Nhóm</th>
                                <th class="text-center">Số lượng</th>

                            </tr>
                        </thead>
                        <tbody>
                            ${groupDetails.map((group, index) => `
                                <tr>
                                    <td class="text-center">${index + 1}</td>
                                    <td class="text-start">
                                        <img src="${group.cover_photo || 'https://via.placeholder.com/50'}" style="width: 100px; height: 50px; object-fit: cover;">
                                        ${group.group_name}
                                    </td>
                                    <td class="text-center">${group.member_count}</td>
                                    
                                </tr>
                            `).join('')}
                        </tbody>
                    `;

                                    createdTableContainer.appendChild(table);


                                    noDataMessage.style.display = 'none';
                                })
                                .catch(error => {
                                    console.error('Lỗi khi lấy chi tiết nhóm:', error);
                                    noDataMessage.style.display = 'block';
                                });
                        } else {
                            noDataMessage.style.display = 'block';
                        }
                    })
                    .catch(error => {
                        console.error('Lỗi khi lấy nhóm đã tạo của người dùng:', error);
                        noDataMessage.style.display = 'block';
                    });
            }


        });




    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hs-sticky-block@1.0.0/dist/hs-sticky-block.min.js"></script>
    <script>
        $(document).on('ready', function () {
            $('.js-sticky-block').each(function () {
                var stickyBlock = new HSStickyBlock($(this), {
                    targetSelector: $('#header').hasClass('navbar-fixed') ? '#header' : null
                }).init();
            });
            var scrollspy = new HSScrollspy($('body'), {
                beforeScroll: function (resolve) {
                    if (window.innerWidth < 992) {
                        $('#navbarVerticalNavMenu').collapse('hide').on('hidden.bs.collapse', function () {
                            return resolve('completed');
                        });
                    } else {
                        return resolve('completed');
                    }
                }
            }).init();
            $('.js-pwstrength').each(function () {
                var pwstrength = $.HSCore.components.HSPWStrength.init($(this));
            });
            function loadUserData(userId) {
                fetch(`http://localhost:8080/onboarding/users/${userId}`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` }
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error("Network response was not ok " + response.statusText);
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Cập nhật thông tin tên người dùng
                        const userNameElements = document.querySelectorAll('.userNameInputs');
                        userNameElements.forEach(element => {
                            element.innerText = data.data.fullname || "Tên chưa cập nhật";
                        });

                        // Cập nhật thông tin vai trò người dùng
                        const companyElements = document.querySelectorAll('.company');
                        companyElements.forEach(element => {
                            element.innerText = data.data.roles[0] || "Chưa có vai trò";
                        });

                        // Cập nhật thông tin ngày tham gia
                        var createAt = data.data.create_at;
                        var year = createAt ? new Date(createAt).getFullYear() : "N/A";  // Nếu không có create_at, hiển thị "N/A"

                        var joinDateElements = document.querySelectorAll(".joinDateClass");
                        joinDateElements.forEach(element => {
                            element.innerText = `Joined ${year}` || "Chưa có thông tin tham gia";
                        });

                        // Cập nhật thông tin email
                        document.getElementById("emailInput").innerText = data.data.email || "Chưa có email";  // Nếu không có email, hiển thị "Chưa có email"

                        // Cập nhật thông tin số điện thoại
                        document.getElementById('phoneInput').innerText = data.data.phoneNumber || "Chưa có số điện thoại";  // Nếu không có phoneNumber, hiển thị "Chưa có số điện thoại"

                        // Cập nhật ảnh đại diện
                        const profileImg = document.getElementById("avatarImgInput");
                        if (data.data.avatarUrl) {
                            profileImg.src = data.data.avatarUrl;
                        } else {
                            const firstLetter = data.data.fullname ? data.data.fullname.charAt(0).toUpperCase() : 'N'; // Nếu không có fullname, dùng 'N'
                            profileImg.src = `https://via.placeholder.com/150/808080/000000?text=${firstLetter}`;
                        }

                        // Tính phần trăm hoàn thiện hồ sơ
                        function calculateProfileCompletion(data) {
                            let completedFields = 0;
                            const totalFields = 5; // Số trường cần hoàn thành (fullname, email, phoneNumber, dob, bio)

                            if (data.fullname) completedFields++;
                            if (data.email) completedFields++;
                            if (data.phoneNumber) completedFields++;
                            if (data.dob) completedFields++;
                            if (data.bio) completedFields++;

                            return (completedFields / totalFields) * 100;
                        }

                        // Cập nhật thanh tiến độ
                        function updateProgressBar(percentage) {
                            const progressBar = document.querySelector(".progress-bar");
                            progressBar.style.width = percentage + "%";
                            progressBar.setAttribute('aria-valuenow', percentage);
                            document.querySelector(".ml-4").innerText = Math.round(percentage) + "%";
                        }

                        const completionPercentage = calculateProfileCompletion(data.data);
                        updateProgressBar(completionPercentage);
                    })
                    .catch(error => {
                        console.error("There was a problem fetching user data:", error);
                    });
            }

            const userId = localStorage.getItem("user_id");
            loadUserData(userId);
            function joinedGroup(userId) {
                const url = `http://localhost:8080/api/member/group-join-id/${userId}`;

                fetch(url, {
                    method: 'GET',
                    headers: AUTH_HEADER,
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Không thể lấy danh sách nhóm người dùng, Mã trạng thái: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        const groupIds = data.data;
                        const groupCount = groupIds ? groupIds.length : 0;
                        console.log(`Người dùng đã tham gia ${groupCount} nhóm`);

                        document.getElementById("joinedGroupCount").innerText = `Bạn đã tham gia: ` + groupCount + ` nhóm`;
                    })
                    .catch(error => {
                        console.error('Lỗi khi lấy danh sách nhóm người dùng:', error);
                    });
            }

            function userCreatedGroups(userId) {
                const url = `http://localhost:8080/api/member/user-create-id/${userId}`;

                fetch(url, {
                    method: 'GET',
                    headers: AUTH_HEADER,
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Không thể lấy danh sách nhóm đã tạo, Mã trạng thái: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        const groupIds = data.data;
                        const groupCount = groupIds ? groupIds.length : 0;

                        document.getElementById("createdGroupCount").innerText = `Bạn đã tạo: ` + groupCount + ` nhóm`;
                    })
                    .catch(error => {
                        console.error('Lỗi khi lấy nhóm đã tạo của người dùng:', error);
                    });
            }

            joinedGroup(userId);
            userCreatedGroups(userId);
        });
        function showModal(type, title, message) {
            document.getElementById('notificationModalLabel').textContent = title;
            document.getElementById('notificationModalBody').textContent = message;

            const modalElement = document.getElementById('notificationModal');
            modalElement.classList.remove('modal-success', 'modal-info', 'modal-warning', 'modal-danger');

            if (type === 'success') {
                modalElement.classList.add('modal-success');
            } else if (type === 'info') {
                modalElement.classList.add('modal-info');
            } else if (type === 'warning') {
                modalElement.classList.add('modal-warning');
            } else if (type === 'danger') {
                modalElement.classList.add('modal-danger');
            }

            const modal = new bootstrap.Modal(modalElement);
            modal.show();
        }

    </script>
    <script th:src="@{/assets/js/userjs.js}"></script>
    <script>
        if (/MSIE \d|Trident.*rv:/.test(navigator.userAgent)) document.write('<script src="./assets/vendor/babel-polyfill/polyfill.min.js"><\/script>');
    </script>

</body>

</html>
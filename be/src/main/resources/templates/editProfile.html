<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Chỉnh sửa trang cá nhân</title>
    <link rel="stylesheet" th:href="@{/assets/css/vendor.min.css}">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&amp;display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/assets/vendor/icon-set/style.css}">
    <link rel="stylesheet" th:href="@{/assets/css/theme.min.css?v=1.0}">

</head>

<body>
    <div th:replace="fragments/buildertoggle"></div>
    <div th:replace="fragments/headerMain"></div>
    <div id="headerFluid" class="d-none">
        <header id="header"
            class="navbar navbar-expand-xl navbar-fixed navbar-height navbar-flush navbar-container navbar-bordered  ">
            <div class="js-mega-menu navbar-nav-wrap">
                <div class="navbar-brand-wrapper">
                    <a class="navbar-brand" th:href="@{/}" aria-label="Front">
                        <img class="navbar-brand-logo" th:src="@{/assets/svg/logos/logo.svg}" alt="Logo">
                    </a>
                </div>
            </div>
        </header>
    </div>
    <div id="headerDouble" class="d-none">
        <header id="header" class="navbar navbar-expand-lg navbar-bordered flex-lg-column px-0">
        </header>
    </div>
    <div th:replace="fragments/sidebarMain"></div>
    <div id="sidebarCompact" class="d-none">
        <aside
            class="js-navbar-vertical-aside navbar navbar-vertical-aside navbar-vertical navbar-vertical-fixed navbar-expand-xl navbar-bordered  ">
            <div class="navbar-vertical-container">
                <div class="navbar-vertical-content">
                </div>
            </div>
        </aside>
    </div>

    <div th:replace="fragments/searchDropdown"></div>
    <div id="content" role="main" class="main pointer-event">
        <div class="content container-fluid">
            <div class="page-header">
                <div class="row align-items-end">
                    <div class="col-sm mb-2 mb-sm-0">

                        <h1 class="page-header-title">Cài đặt</h1>
                    </div>

                    <div class="col-sm-auto">
                        <a class="btn btn-primary" th:href="@{/web-server/profile}">
                            <i class="tio-user mr-1"></i>Hồ sơ của tôi
                        </a>
                    </div>

                </div>
            </div>

            <div class="row">
                <div class="col-lg-3">
                    <!-- Navbar -->
                    <div class="navbar-vertical navbar-expand-lg mb-3 mb-lg-5">
                        <!-- Navbar Toggle -->
                        <button type="button" class="navbar-toggler btn btn-block btn-white mb-3"
                            aria-label="Toggle navigation" aria-expanded="false" aria-controls="navbarVerticalNavMenu"
                            data-toggle="collapse" data-target="#navbarVerticalNavMenu">
                            <span class="d-flex justify-content-between align-items-center">
                                <span class="h5 mb-0">Nav menu</span>

                                <span class="navbar-toggle-default">
                                    <i class="tio-menu-hamburger"></i>
                                </span>

                                <span class="navbar-toggle-toggled">
                                    <i class="tio-clear"></i>
                                </span>
                            </span>
                        </button>
                        <!-- End Navbar Toggle -->

                        <div id="navbarVerticalNavMenu" class="collapse navbar-collapse">
                            <!-- Navbar Nav -->
                            <ul id="navbarSettings"
                                class="js-sticky-block js-scrollspy navbar-nav navbar-nav-lg nav-tabs card card-navbar-nav"
                                data-hs-sticky-block-options='{
                           "parentSelector": "#navbarVerticalNavMenu",
                           "breakpoint": "lg",
                           "startPoint": "#navbarVerticalNavMenu",
                           "endPoint": "#stickyBlockEndPoint",
                           "stickyOffsetTop": 20
                         }'>
                                <li class="nav-item">
                                    <a class="nav-link active" href="#contents">
                                        <i class="tio-user-outlined nav-icon"></i> Thông tin cơ bản
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="#passwordSection">
                                        <i class="tio-lock-outlined nav-icon"></i> Mật khẩu
                                    </a>
                                </li>
                            </ul>
                            <!-- End Navbar Nav -->
                        </div>
                    </div>
                    <!-- End Navbar -->
                </div>

                <div class="col-lg-9">
                    <div class="mb-3 mb-lg-5" id="contents">
                        <div class="card">
                            <div class="profile-cover">
                                <div class="profile-cover-img-wrapper">
                                    <img id="profileCoverImg" class="profile-cover-img"
                                        src="/assets/img/1920x400/img2.jpg" alt="Image Description">
                                    <div class="profile-cover-content profile-cover-btn">
                                        <div class="custom-file-btn">

                                        </div>
                                    </div>
                                </div>
                            </div>
                            <label
                                class="avatar avatar-xxl avatar-circle avatar-border-lg avatar-uploader profile-cover-avatar"
                                for="avatarUploader">
                                <img id="profileImg" class="avatar-img" src="assets\img\160x160\img6.jpg"
                                    alt="Image Description">

                                <input type="file" class="js-file-attach avatar-uploader-input" id="avatarUploader"
                                    data-hs-file-attach-options='{
                                        "textTarget": "#profileImg",
                                        "mode": "image",
                                        "targetAttr": "src",
                                        "allowTypes": [".png", ".jpeg", ".jpg"]
                                    }'>

                                <span class="avatar-uploader-trigger">
                                    <i class="tio-edit avatar-uploader-icon shadow-soft"></i>
                                </span>
                            </label>

                            <div class="card-header">
                                <h2 class="card-title h4">Thông tin cơ bản</h2>
                            </div>

                            <div class="card-body">
                                <div class="row form-group">
                                    <label for="fullNameInput" class="col-sm-3 col-form-label input-label">Họ và
                                        Tên</label>
                                    <div class="col-sm-9">
                                        <div class="input-group input-group-sm-down-break">
                                            <input type="text" class="form-control" id="fullNameInput"
                                                placeholder="Họ và Tên của bạn" readonly>
                                        </div>
                                    </div>
                                </div>

                                <div class="row form-group">
                                    <label for="emailInput" class="col-sm-3 col-form-label input-label">Email</label>
                                    <div class="col-sm-9">
                                        <input type="email" class="form-control" id="emailInput" placeholder="Email"
                                            readonly>
                                    </div>
                                </div>

                                <div class="row form-group">
                                    <label for="phoneInput" class="col-sm-3 col-form-label input-label">Số điện
                                        thoại</label>
                                    <div class="col-sm-9">
                                        <input type="text" class="form-control" id="phoneInput"
                                            placeholder="+x(xxx)xxx-xx-xx">
                                    </div>
                                </div>

                                <div class="row form-group">
                                    <label for="dobInput" class="col-sm-3 col-form-label input-label">Ngày sinh</label>
                                    <div class="col-sm-9">
                                        <input type="date" class="form-control" id="dobInput">
                                    </div>
                                </div>

                                <div class="row form-group">
                                    <label for="bioInput" class="col-sm-3 col-form-label input-label">Tiểu sử</label>
                                    <div class="col-sm-9">
                                        <textarea class="form-control" id="bioInput" rows="3"></textarea>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <button type="button" class="btn btn-secondary" id="changeFullname">Thay đổi
                                        tên</button>
                                    <button type="submit" class="btn btn-primary" id="saveChangeProfile">Lưu</button>
                                </div>
                            </div>

                        </div>
                    </div>
                    <div id="passwordSection" class="card mb-3 mb-lg-5">
                        <div class="card-header">
                            <h4 class="card-title">Thay đổi mật khẩu</h4>
                        </div>

                        <div class="card-body">
                            <div class="row form-group">
                                <label for="currentPasswordLabel" class="col-sm-3 col-form-label input-label">Mật
                                    khẩu hiện tại</label>
                                <div class="col-sm-9">
                                    <input type="password" class="form-control" name="currentPassword"
                                        id="currentPasswordLabel" placeholder="Nhập mật khẩu hiện tại"
                                        aria-label="Nhập mật khẩu hiện tại">
                                </div>
                            </div>
                            <div class="row form-group">
                                <label for="newPassword" class="col-sm-3 col-form-label input-label">Mật khẩu
                                    mới</label>
                                <div class="col-sm-9">
                                    <input type="password" class="js-pwstrength form-control" name="newPassword"
                                        id="newPassword" placeholder="Nhập mật khẩu mới" aria-label="Nhập mật khẩu mới"
                                        data-hs-pwstrength-options='{
                                           "ui": {
                                             "container": "#changePasswordForm",
                                             "viewports": {
                                               "progress": "#passwordStrengthProgress",
                                               "verdict": "#passwordStrengthVerdict"
                                             }
                                           }
                                         }'>

                                    <p id="passwordStrengthVerdict" class="form-text mb-2"></p>
                                    <div id="passwordStrengthProgress"></div>
                                </div>
                            </div>
                            <div class="row form-group">
                                <label for="confirmNewPasswordLabel" class="col-sm-3 col-form-label input-label">Xác
                                    nhận mật khẩu mới</label>
                                <div class="col-sm-9">
                                    <div class="mb-3">
                                        <input type="password" class="form-control" name="confirmNewPassword"
                                            id="confirmNewPasswordLabel" placeholder="Xác nhận mật khẩu mới"
                                            aria-label="Xác nhận mật khẩu mới">
                                    </div>

                                    <h5>Yêu cầu mật khẩu:</h5>

                                    <p class="font-size-sm mb-2">Đảm bảo rằng các yêu cầu sau được đáp ứng:</p>

                                    <ul class="font-size-sm">
                                        <li>Ít nhất 8 ký tự - càng dài càng tốt</li>
                                        <li>Ít nhất một ký tự viết thường</li>
                                        <li>Ít nhất một ký tự viết hoa</li>
                                        <li>Ít nhất một ký tự số, ký hiệu hoặc ký tự trắng</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="d-flex justify-content-end">
                                <button type="submit" class="btn btn-primary" id="savePass">Lưu</button>
                            </div>
                        </div>
                    </div>

                    <div id="stickyBlockEndPoint"></div>
                </div>
            </div>
        </div>
        <div th:replace="fragments/profile/changeFullnameModal"></div>
        <div th:replace="fragments/notification"></div>


    </div>
    <script th:src="@{/assets/js/demo.js}"></script>
    <script th:src="@{/assets/js/vendor.min.js}"></script>
    <script th:src="@{/assets/js/theme.min.js}"></script>
    <!-- <script th:src="@{/assets/js/userjs.js}"></script> -->
    <script>
        $(document).on('ready', function () {
            $('.js-navbar-vertical-aside-toggle-invoker').click(function () {
                $('.js-navbar-vertical-aside-toggle-invoker i').tooltip('hide');
            });
            var megaMenu = new HSMegaMenu($('.js-mega-menu'), {
                desktop: {
                    position: 'left'
                }
            }).init();
            var sidebar = $('.js-navbar-vertical-aside').hsSideNav();
            $('.js-nav-tooltip-link').tooltip({ boundary: 'window' });
            $(".js-nav-tooltip-link").on("show.bs.tooltip", function (e) {
                if (!$("body").hasClass("navbar-vertical-aside-mini-mode")) {
                    return false;
                }
            });
        });
        $('.js-hs-unfold-invoker').each(function () {
            var unfold = new HSUnfold($(this)).init();
        });

        document.getElementById("logoutLink").addEventListener("click", function () {
            window.location.replace("/web-server/login");
        });

    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hs-sticky-block@1.0.0/dist/hs-sticky-block.min.js"></script>
    <script>
        $(document).on('ready', function () {
            $('.js-sticky-block').each(function () {
                var stickyBlock = new HSStickyBlock($(this), {
                    targetSelector: $('#header').hasClass('navbar-fixed') ? '#header' : null
                }).init();
            });
            var scrollspy = new HSScrollspy($('body'), {
                beforeScroll: function (resolve) {
                    if (window.innerWidth < 992) {
                        $('#navbarVerticalNavMenu').collapse('hide').on('hidden.bs.collapse', function () {
                            return resolve('completed');
                        });
                    } else {
                        return resolve('completed');
                    }
                }
            }).init();
            $('.js-pwstrength').each(function () {
                var pwstrength = $.HSCore.components.HSPWStrength.init($(this));
            });

        });
        var token = localStorage.getItem("authToken");



        function isTokenExpired(token) {
            if (!token) return true;

            const payloadBase64 = token.split('.')[1];
            const decodedPayload = JSON.parse(atob(payloadBase64));

            const expirationTime = decodedPayload.exp;

            const expirationDate = new Date(expirationTime * 1000); // Corrected declaration

            console.log(expirationDate);

            const currentTime = Math.floor(Date.now() / 1000);
            return expirationTime < currentTime;
        }

        if (isTokenExpired(token)) {
            showModal('warning', 'Hết phiên đăng nhập', 'Phiên đăng nhập của bạn đã hết hạn. Vui lòng đăng nhập lại.');
            setTimeout(() => {
                window.location.href = '/web-server/login';
            }, 1000);
        }
        let initialData = {};

        function loadUserData(userId) {
            fetch(`http://localhost:8080/onboarding/users/${userId}`, {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${token}` }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Network response was not ok " + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log(data);

                    const formattedDob = data.data.dob;
                    initialData = {
                        fullname: data.data.fullname || "",
                        email: data.data.email || "",
                        phoneNumber: data.data.phoneNumber || "",
                        dob: formattedDob,
                        bio: data.data.bio || "",
                        avatarUrl: data.data.avatarUrl || ""
                    };
                    document.getElementById("fullNameInput").value = data.data.fullname || "";
                    document.getElementById("emailInput").value = data.data.email || "";
                    document.getElementById("phoneInput").value = data.data.phoneNumber || "";
                    document.getElementById("dobInput").value = formattedDob;
                    document.getElementById("bioInput").value = data.data.bio || "";

                    const profileImg = document.getElementById("profileImg");

                    if (initialData.avatarUrl) {
                        profileImg.src = initialData.avatarUrl;
                    } else {
                        const firstLetter = initialData.fullname.charAt(0).toUpperCase();
                        profileImg.src = `https://via.placeholder.com/150/808080/000000?text=${firstLetter}`;
                    }

                    toggleSaveButton();
                })
                .catch(error => {
                    console.error("There was a problem fetching user data:", error);
                });
        }

        function checkForChanges() {
            const phoneNumber = document.getElementById('phoneInput').value;
            const dob = document.getElementById('dobInput').value;
            const bio = document.getElementById('bioInput').value;
            const avatarFile = document.getElementById('avatarUploader').files[0];

            const isChanged = phoneNumber !== initialData.phoneNumber ||
                dob !== initialData.dob ||
                bio !== initialData.bio ||
                (avatarFile ? avatarFile.name !== initialData.avatarUrl : false);

            toggleSaveButton(isChanged);
        }

        function toggleSaveButton(isChanged = false) {
            const saveButton = document.getElementById("saveChangeProfile");
            saveButton.disabled = !isChanged;
        }

        document.getElementById('phoneInput').addEventListener('input', checkForChanges);
        document.getElementById('dobInput').addEventListener('input', checkForChanges);
        document.getElementById('bioInput').addEventListener('input', checkForChanges);
        document.getElementById('avatarUploader').addEventListener('change', checkForChanges);

        const userId = localStorage.getItem("user_id");
        // console.log(userId);

        loadUserData(userId);

        document.getElementById('avatarUploader').addEventListener('change', function (event) {
            const file = event.target.files[0];
            const validImageTypes = ['image/jpeg', 'image/png', 'image/jpg'];

            if (file && validImageTypes.includes(file.type)) {
                const reader = new FileReader();

                reader.onload = function (e) {
                    document.getElementById('profileImg').src = e.target.result;
                };
                reader.readAsDataURL(file);
            } else {
                alert('Vui lòng chọn ảnh có định dạng .jpg, .jpeg hoặc .png');
            }
        });

        document.getElementById("saveChangeProfile").addEventListener('click', function () {
            const phoneNumber = document.getElementById('phoneInput').value;
            const dob = document.getElementById('dobInput').value;
            const bio = document.getElementById('bioInput').value;
            const avatarFile = document.getElementById('avatarUploader').files[0];

            const phoneRegex = /^(\\+84|84|0)(3|5|7|8|9|1[2689])[0-9]{8}$/;
            if (!phoneRegex.test(phoneNumber)) {
                alert("Vui lòng nhập số điện thoại hợp lệ.");
                return;
            }
            const updateDTO = {
                phoneNumber: phoneNumber,
                dob: dob,
                bio: bio,
            };

            const formData = new FormData();
            formData.append("updateDTO", JSON.stringify(updateDTO));
            if (avatarFile) {
                formData.append('avatar', avatarFile);
            }
            fetch(`http://localhost:8080/onboarding/change-profile/${userId}`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                },
                body: formData,
            })
                .then(res => res.json())
                .then(data => {
                    if (data.status) {
                        alert("Cập nhật profile thành công!");
                        location.reload();
                    }
                })
                .catch(err => {
                    console.log("Loi" + err);
                });
        });

        //change password
        async function changePassword() {
            const currentPassword = document.getElementById('currentPasswordLabel').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPasswordLabel').value;
            const savedPassword = localStorage.getItem("savedPassword");

            console.log(savedPassword); // In ra mật khẩu đã lưu để kiểm tra
            if (!currentPassword || !newPassword || !confirmNewPassword) {
                alert('Vui lòng nhập đầy đủ tất cả các trường mật khẩu.');
                return;
            }

            if (currentPassword !== savedPassword) {
                alert('Mật khẩu hiện tại không chính xác.');
                return;
            }

            if (newPassword !== confirmNewPassword) {
                alert('Mật khẩu mới và xác nhận mật khẩu không khớp.');
                return;
            }

            if (newPassword.length < 8) {
                alert('Mật khẩu mới phải có ít nhất 8 ký tự.');
                return;
            }

            const passwordPattern = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/;
            if (!passwordPattern.test(newPassword)) {
                alert('Mật khẩu mới phải chứa ít nhất một ký tự viết hoa, một ký tự viết thường, một số và một ký tự đặc biệt.');
                return;
            }

            if (currentPassword === newPassword) {
                alert('Mật khẩu mới không được giống mật khẩu cũ.');
                return;
            }

            const data = {
                email: localStorage.getItem("savedEmail"),
                password: newPassword
            };
            fetch("http://localhost:8080/onboarding/set-password", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(data)
            })
                .then(response => response.json())
                .then(data => {
                    alert('Mật khẩu đã được thay đổi thành công!');

                    setTimeout(() => {
                        alert('Vui lòng đăng nhập lại để tiếp tục sử dụng!');
                        window.location.href = "/web-server/login";
                    }, 2000);
                })
                .catch(error => {
                    console.error('Lỗi:', error);
                    alert('Đã xảy ra lỗi khi gửi yêu cầu.');
                });



        }


        document.getElementById("savePass").addEventListener('click', (e) => {
            e.preventDefault();
            changePassword();
        });

        document.getElementById("changeFullname").addEventListener("click", (e) => {
            e.preventDefault();
            const modal = new bootstrap.Modal(document.getElementById('changeFullNameProfileModal'));
            modal.show();
        })

        document.getElementById("saveName").addEventListener("click", function (event) {
            event.preventDefault();

            const userId = localStorage.getItem("user_id");
            const newFullname = document.getElementById("newFullName").value;


            function validateFullname(name) {
                // Kiểm tra tên có trống không
                if (!name || name.trim() === "") {
                    return "Tên không được để trống!";
                }

                const firstChar = name.charAt(0);
                if (!/^[A-Za-zÀÁÂÃÈÉÊÌÍÒÓÔÕÙÚĂĐĨŨƠàáâãèéêìíòóôõùúăđĩũơƯĂÂÊÔƠƯ áàảãạăắằẳẵặâấầẩẫậéèẻẽẹêếềểễệíìỉĩịóòỏõọôốồổỗộơớờởỡợúùủũụưứừửữựýỳỷỹỵ\s]/.test(firstChar)) {
                    return "Tên phải bắt đầu bằng chữ cái!";
                }

                if (/[^A-Za-zÀÁÂÃÈÉÊÌÍÒÓÔÕÙÚĂĐĨŨƠàáâãèéêìíòóôõùúăđĩũơƯĂÂÊÔƠƯ áàảãạăắằẳẵặâấầẩẫậéèẻẽẹêếềểễệíìỉĩịóòỏõọôốồổỗộơớờởỡợúùủũụưứừửữựýỳỷỹỵ\s]/.test(name)) {
                    return "Tên không được chứa ký tự đặc biệt ngoài dấu cách!";
                }

                // Kiểm tra độ dài của tên
                if (name.length < 3 || name.length > 100) {
                    return "Tên phải có độ dài từ 3 đến 100 ký tự!";
                }

                return null; // Trả về null nếu tên hợp lệ
            }

            console.log(newFullname);

            const validationError = validateFullname(newFullname);
            if (validationError) {
                alert(validationError);
                return;
            }

            const encodedFullname = encodeURIComponent(newFullname);

            fetch(`http://localhost:8080/onboarding/change-full-name/${userId}?newName=${encodedFullname}`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status) {
                        alert('Cập nhật tên thành công!');
                        location.reload();  // Cập nhật lại trang nếu cần
                    } else {
                        alert('Cập nhật tên thất bại: ' + (data.error?.message || 'Lỗi không xác định.'));
                    }
                })
                .catch(error => {
                    console.error('Có lỗi xảy ra:', error);
                    alert('Có lỗi xảy ra khi cập nhật tên. Vui lòng thử lại.');
                });
        });
        function showModal(type, title, message) {
            document.getElementById('notificationModalLabel').textContent = title;
            document.getElementById('notificationModalBody').textContent = message;

            const modalElement = document.getElementById('notificationModal');
            modalElement.classList.remove('modal-success', 'modal-info', 'modal-warning', 'modal-danger');

            if (type === 'success') {
                modalElement.classList.add('modal-success');
            } else if (type === 'info') {
                modalElement.classList.add('modal-info');
            } else if (type === 'warning') {
                modalElement.classList.add('modal-warning');
            } else if (type === 'danger') {
                modalElement.classList.add('modal-danger');
            }

            const modal = new bootstrap.Modal(modalElement);
            modal.show();
        }
        $(document).on('ready', function () {
            if (window.localStorage.getItem('hs-builder-popover') === null) {
                $('#builderPopover').popover('show')
                    .on('shown.bs.popover', function () {
                        $('.popover').last().addClass('popover-dark')
                    });

                $(document).on('click', '#closeBuilderPopover', function () {
                    window.localStorage.setItem('hs-builder-popover', true);
                    $('#builderPopover').popover('dispose');
                });
            } else {
                $('#builderPopover').on('show.bs.popover', function () {
                    return false
                });
            }


        });

    </script>
    <!-- <script th:src="@{/assets/js/userjs.js}"></script> -->
    <script>
        if (/MSIE \d|Trident.*rv:/.test(navigator.userAgent)) document.write('<script src="./assets/vendor/babel-polyfill/polyfill.min.js"><\/script>');
    </script>

</body>

</html>
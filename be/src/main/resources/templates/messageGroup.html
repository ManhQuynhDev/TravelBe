<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Quản lý nhân viên</title>
    <link rel="stylesheet" th:href="@{/assets/css/vendor.min.css}">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&amp;display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/assets/vendor/icon-set/style.css}">
    <link rel="stylesheet" th:href="@{/assets/css/theme.min.css?v=1.0}">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

    <style>
        body {
            background-color: #f7f9fc;
            font-family: 'Arial', sans-serif;
        }

        .chat-sidebar {
            border-right: 1px solid #e0e0e0;
            background-color: #ffffff;
            height: calc(100vh - 65px);
        }

        .chat-sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .chat-sidebar-header h5 {
            font-weight: bold;
            margin-bottom: 0;
        }

        .chat-search {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .chat-search input {
            border-radius: 20px;
        }

        .chat-list {
            overflow-y: auto;
            height: calc(100vh - 140px);
        }

        .chat-item {
            width: 100%;
            padding: 15px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .chat-item:hover {
            background-color: #f0f4f8;
        }

        .chat-item img {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .chat-item .chat-info h6 {
            margin: 0;
            font-weight: bold;
        }

        .chat-item .chat-info small {
            color: #777;
        }

        .chat-main {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 65px);
            background-color: #f9fafe;
        }

        .chat-header {
            height: 60.32px;
            padding-left: 20px;
            padding-right: 20px;
            background-color: #ffffff;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header h5 {
            margin: 0;
            font-weight: bold;
        }

        .chat-body {
            min-height: calc(100vh - 215px);
            padding: 10px;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
        }

        .message.received .bubble {
            background-color: #ffffff;
            border: 1px solid #ddd;
        }

        .message.sent .bubble {
            background-color: #007bff;
            color: #fff;
        }

        .bubble {
            padding: 10px 15px;
            border-radius: 20px;
            max-width: 60%;
            font-size: 14px;
        }

        .chat-footer {
            padding: 15px;
            background-color: #ffffff;
            border-top: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-footer input {
            border-radius: 20px;
            margin-right: 10px;
        }

        .chat-footer button {
            border-radius: 20px;
        }

        #messageArea {
            height: calc(100vh - 260px);
            overflow: auto;
            display: flex;
            flex-direction: column;
        }

        .avatar_show {
            width: 50px;
            height: 50px;
            border-radius: 25px;
            color: white;
            font-size: 26px;
            line-height: 45px;
            text-align: center;
        }

        .message {
            max-width: 80%;
            min-height: 100;
            border-radius: 25px;
            color: black;
            font-size: 20px;
            line-height: 30px;
            padding-left: 20px;
            padding-right: 20px;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .incoming,
        .me {
            margin: 5px;
        }

        .message-time {
            font-size: 0.75rem;
            color: #888;
            text-align: left;
        }

        .incoming .avatar_show,
        .typing .avatar_show {
            background-color: #0f6ab4;
            float: left;
        }

        .me .avatar_show {
            background-color: #10a54a;
            float: right;
        }

        .incoming .message {
            background-color: #d7e3f0;
            float: left;
            margin-left: 10px;
        }

        .me .message {
            background-color: #c1f3d2;
            float: right;
            margin-right: 10px;
        }

        .joined {
            text-align: center;
            background-color: rgb(176, 255, 229);
            margin: 10px;
            border-radius: 10px;
        }

        .left {
            text-align: center;
            background-color: rgb(255, 152, 174);
            margin: 10px;
            border-radius: 10px;
        }

        .file-upload-icon-container {
            display: inline-block;
            position: relative;
        }

        .file-icon {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 50px;
            height: 50px;
            background-color: #007bff;
            border-radius: 50%;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .file-icon:hover {
            background-color: #0056b3;
            transform: scale(1.1);
        }

        .file-icon:active {
            background-color: #004080;
            transform: scale(1);
        }

        .upload-icon {
            font-size: 24px;
            color: white;
        }

        input[type="file"] {
            display: none;
        }

        .message-image {
            width: 200px;
            /* Chiều rộng */
            height: 200px;
            /* Chiều cao */
            object-fit: cover;
            /* Đảm bảo hình ảnh không bị méo */
            border-radius: 8px;
            /* Tùy chọn: bo góc */
        }

        .typing-status {
            height: 20px;
            padding-bottom: 10px;
            font-size: 14px;
            color: #888;
        }


        .seenMe {
            justify-content: flex-end;
            /* Căn phải cho người gửi */
            text-align: right;
            /* Căn nội dung về bên phải */
        }

        .seenIncoming {
            justify-content: flex-start;
            /* Căn trái cho người nhận */
            text-align: left;
            /* Căn nội dung về bên trái */
        }

        .emoji-popup {
            display: none;
            /* Hide initially */
            position: absolute;
            border: 1px solid #ccc;
            background-color: #fff;
            padding: 10px;
            border-radius: 45px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .emoji-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .emoji {
            font-size: 24px;
            cursor: pointer;
        }

        .emoji:hover {
            transform: scale(1.2);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #2172dd;
            color: white;
            padding: 15px;
            border-radius: 5px;
            display: none;
            z-index: 9999;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 300px;
        }

        .notification-content {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        #notificationTitle {
            font-weight: bold;
        }

        #notificationMessage {
            margin-top: 5px;
        }
    </style>
</head>

<body>
    <div th:replace="fragments/headerMain"></div>
    <div id="headerFluid" class="d-none">
        <header id="header"
            class="navbar navbar-expand-xl navbar-fixed navbar-height navbar-flush navbar-container navbar-bordered">
            <div class="js-mega-menu navbar-nav-wrap">
                <div class="navbar-brand-wrapper">
                    <a class="navbar-brand" th:href="@{/}" aria-label="Front">
                        <img class="navbar-brand-logo" th:src="@{/svg/logos/logo.svg}" alt="Logo">
                    </a>
                </div>
            </div>
        </header>
    </div>
    <!-- Header -->
    <div id="headerDouble" class="d-none">
        <header id="header" class="navbar navbar-expand-lg navbar-bordered flex-lg-column px-0">
        </header>
    </div>
    <!-- Ene Header -->
    <div th:replace="fragments/sidebarMain"></div>
    <div id="sidebarCompact" class="d-none">
        <aside
            class="js-navbar-vertical-aside navbar navbar-vertical-aside navbar-vertical navbar-vertical-fixed navbar-expand-xl navbar-bordered">
            <div class="navbar-vertical-container">
                <div class="navbar-vertical-content">
                </div>
            </div>
        </aside>
    </div>
    <div th:replace="fragments/searchDropdown"></div>
    <div id="content" role="main" class="main pointer-event">
        <div class="container-fluid">
            <div class="row">
                <!-- Sidebar -->
                <div class="col-4 chat-sidebar">
                    <div class="chat-sidebar-header">
                        <h5>All Messages</h5>
                    </div>
                    <div class="chat-search">
                        <input type="text" class="form-control" placeholder="Search or start a new chat">
                    </div>

                    <ul id="managerList" style="padding-inline-start: 0px;"></ul>
                </div>

                <!-- Chat -->
                <div class="col-8 chat-main">
                    <div class="chat-header d-flex justify-content-between align-items-center userInfo">
                        <h5>Select a chat to start messaging</h5>
                    </div>
                    <div class="chat-body">
                        <p class="text-muted">No chat selected</p>
                    </div>
                    <div class="chat-footer">
                        <input type="text" id="chat-mes" class="form-control" placeholder="Type your message here...">

                        <div class="file-upload-icon-container mr-2">
                            <label for="fileInput" class="file-icon">
                                <i class="fas fa-image upload-icon"></i>
                            </label>
                            <input type="file" id="fileInput" accept="image/*" />
                        </div>


                        <button class="btn btn-primary" id="btnSubmit">Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="notification" class="notification">
        <div class="notification-content">
            <span id="notificationTitle">Thông Báo</span>
            <img id="notificationImage" src="" alt="Notification Image" style="max-width: 100%; display: none;">
            <p id="notificationMessage">Đây là nội dung thông báo.</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <script src="/assets/js/jquery.min.js"></script>
    <script src="/assets/js/socket.io.js"></script>
    <script th:src="@{/assets/js/demo.js}"></script>
    <script th:src="@{/assets/js/vendor.min.js}"></script>
    <script th:src="@{/assets/js/theme.min.js}"></script>

    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>

    <script>
        $(document).on('ready', function () {
            $('.js-navbar-vertical-aside-toggle-invoker').click(function () {
                $('.js-navbar-vertical-aside-toggle-invoker i').tooltip('hide');
            });
            var megaMenu = new HSMegaMenu($('.js-mega-menu'), {
                desktop: {
                    position: 'left'
                }
            }).init();
            var sidebar = $('.js-navbar-vertical-aside').hsSideNav();
            $('.js-nav-tooltip-link').tooltip({ boundary: 'window' });
            $(".js-nav-tooltip-link").on("show.bs.tooltip", function (e) {
                if (!$("body").hasClass("navbar-vertical-aside-mini-mode")) {
                    return false;
                }
            });
        });
        $('.js-hs-unfold-invoker').each(function () {
            var unfold = new HSUnfold($(this)).init();
        });
    </script>

    <script>
        const list_notification = document.querySelector("#list_notification");
        const managerList = document.querySelector('#managerList');
        const chatbody = document.querySelector('.chat-body');
        const user_received = document.querySelector('#user_received');
        const userInfo = document.querySelector('.userInfo');
        const chatMess = document.querySelector('#chat-mes');
        const submit = document.querySelector('#btnSubmit');
        const fileInput = document.querySelector("#fileInput");
        const token = localStorage.getItem('authToken');
        const senderId = localStorage.getItem('user_id');
        console.log(list_notification);

        let currentManagerId = null;

        const handelCallData = async () => {
            try {
                const managersResponse = await fetch(`http://localhost:8080/onboarding/users/manager?page=0&size=1000`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                });

                if (!managersResponse.ok) {
                    throw new Error(`HTTP error! Status: ${managersResponse.status}`);
                }

                const managersData = await managersResponse.json();
                const managers = managersData.content.filter(manager => manager.id.toString() !== senderId.toString());
                console.log(managers);

                managerList.innerHTML = '';

                for (const manager of managers) {
                    try {
                        const messageResponse = await fetch(`http://localhost:8080/api/messages/last-message/${manager.id}`, {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json',
                            },
                        });

                        if (!messageResponse.ok) {
                            console.warn(`Message API returned status ${messageResponse.status} for manager ${manager.id}`);
                            continue;
                        }

                        const messageData = await messageResponse.json();

                        const messageTime = new Date(messageData.sendTime);
                        const currentTime = new Date();

                        const timeDifference = currentTime - messageTime;

                        const minutesDifference = Math.floor(timeDifference / (1000 * 60));

                        let timeDisplay;
                        if (minutesDifference < 60) {
                            timeDisplay = `${minutesDifference} phút`;
                        } else if (minutesDifference < 1440) {
                            const hoursDifference = Math.floor(minutesDifference / 60);
                            timeDisplay = `${hoursDifference} giờ`;
                        } else {
                            const daysDifference = Math.floor(minutesDifference / 1440);
                            timeDisplay = `${daysDifference} ngày`;
                        }

                        const li = document.createElement('li');
                        li.className = 'chat-item d-flex align-items-center mb-3 managerItem';
                        li.setAttribute('data-parent', manager.id);

                        li.innerHTML = `
    <!-- Avatar hoặc chữ cái đầu -->
    ${manager.avatarUrl ? `
    <img src="${manager.avatarUrl}" alt="Avatar" 
         class="rounded-circle mr-2 img-fluid" 
         style="width: 40px; height: 40px; object-fit: cover; flex-shrink: 0;">
` : `
    <div class="d-flex justify-content-center align-items-center rounded-circle mr-2" 
         style="background-color: #2172dd; color: #fff; width: 40px; height: 40px; font-size: 14px; font-weight: bold; flex-shrink: 0;">
        <span>${manager.fullname ? manager.fullname.charAt(0).toUpperCase() : 'N'}</span>
    </div>
`}

    <!-- Nội dung tin nhắn -->
    <div class="chat-info flex-grow-1">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0 text-truncate" style="max-width: 70%; min-width: 100px;">${manager.fullname}</h5>
            <span class="text-muted small">${timeDisplay}</span>
        </div>
        <span class="d-block text-break text-wrap">${messageData.content ? messageData.content : 'No message available'}</span>
    </div>
`;
                        li.addEventListener('click', () => {
                            if (currentManagerId !== manager.id) {
                                currentManagerId = manager.id;
                                showMessage(manager.id);
                            }
                        });

                        managerList.appendChild(li);

                    } catch (err) {
                        console.error(`Error fetching last message for manager ${manager.id}:`, err);
                    }
                }
            } catch (err) {
                console.error('Error fetching manager data:', err);
            }
        };


        const handelCallNotification = async () => {
            try {
                // Gửi yêu cầu GET đến API
                const response = await fetch(`http://localhost:8080/api/notifications/${senderId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                });

                if (!response.ok) {
                    throw new Error(`Error: ${response.status} - ${response.statusText}`);
                }


                const responseText = await response.text();

                if (!responseText) {
                    console.warn('Không có dữ liệu trả về từ API');
                    return null;  // Trả về null nếu không có dữ liệu
                }


                try {
                    const data = JSON.parse(responseText); // Sử dụng JSON.parse() thay vì .json()


                    if (data.status === false) {
                        console.error('Lỗi từ API:', data.message);
                        return null;
                    }

                    const notifications = data.data;

                    notifications.forEach(notification => {
                        const listItem = document.createElement('li');
                        listItem.classList.add('list-group-item', 'custom-checkbox-list-wrapper');

                        listItem.innerHTML = `
                                <div class="row">
                                    <div class="col-auto position-static">
                                        <div class="d-flex align-items-center">
                                            <div class="avatar avatar-sm avatar-circle">
                                                <!-- Nếu avatarUrl không có, hiển thị chữ cái đầu tiên của fullname -->
                                                ${notification.avatarUrl ?
                                `<img class="avatar-img" src="${notification.avatarUrl}" alt="Avatar">` :
                                `<div class="d-flex justify-content-center align-items-center rounded-circle mr-2" 
                                                        style="background-color: #2172dd; color: #fff; width: 40px; height: 40px; font-size: 14px; font-weight: bold; flex-shrink: 0;">
                                                        <span>${notification.fullname ? notification.fullname.charAt(0).toUpperCase() : 'N'}</span>
                                                    </div>`
                            }
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col ml-n3">
                                        <span class="card-title h5">${notification.fullname}</span>
                                        <p class="card-text font-size-sm">${notification.message}</p>
                                    </div>
                                    <small class="col-auto text-muted text-cap">${new Date(notification.notificationTime).toLocaleString()}</small>
                                </div>
                                <a class="stretched-link" href="#"></a>
                            `;


                        // Thêm thông báo vào danh sách
                        list_notification.appendChild(listItem);
                    });

                    return notifications;

                } catch (jsonError) {
                    console.error('Lỗi khi phân tích JSON:', jsonError);
                    return null;
                }

            } catch (error) {
                console.error('Lỗi khi gọi API:', error);
                return null;
            }
        };

        handelCallNotification();
        handelCallData();

        const showMessage = (user_id) => {
            const userId = user_id.toString();
            fetch(`http://localhost:8080/onboarding/users/fullname/${userId}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                },
            })
                .then(res => {
                    if (!res.ok) {
                        throw new Error(`HTTP error! Status: ${res.status}`);
                    }
                    return res.text();
                })
                .then(data => {
                    userInfo.innerHTML = `
                        <div class="d-flex justify-content-center align-items-center" 
                            style="display: flex; flex-direction: row; align-items: center; justify-content: center; text-align: center;">
                            <div class="avatar1-text" 
                                style="background-color: #2172dd; color: #fafafa; display: flex; justify-content: center; align-items: center; 
                                        width: 45px; height: 45px; font-size: 16px; font-weight: bold; border-radius: 50%; margin-right: 10px;">
                                <span>${data.substring(0, 1).toUpperCase()}</span>
                            </div>
                            <h5>${data}</h5>
                        </div>
                        <div>
                        <button class="btn" style="background-color: #00b894; color: white; border: none; padding: 10px 20px; border-radius: 5px;">
                            <i class="fas fa-video"></i>
                        </button>

                        <button class="btn" style="background-color: #00b894; color: white; border: none; padding: 10px 20px; border-radius: 5px;">
                            <i class="fas fa-phone"></i>
                        </button>

                        <button class="btn" style="background-color: #00b894; color: white; border: none; padding: 10px 20px; border-radius: 5px;">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                    </div>
                     `;
                })
                .catch(err => console.error('Error:', err));

            const socketUrl = location.protocol + "//" + location.hostname + ":1111/private";
            console.log(socketUrl);

            const socket = io.connect(socketUrl, {
                query: { sender: senderId, receiverId: userId }
            });

            socket.on('connect', () => {
                console.log("Connected with socket ID: ", socket.id);
            });

            socket.on('connect_error', (error) => {
                console.error('Connection failed: ', error);
            });

            const content = `<div id="messageArea" class="col s12">
				
			</div>
            <div id="seen-users"></div>
            <ul id="typing-status"></ul>
            <div id="emojiPopup" class="emoji-popup">
                    <div class="emoji-container">
                        <span class="emoji" data-emoji="LIKE">👍</span>
                        <span class="emoji" data-emoji="HAHA">😆</span>
                        <span class="emoji" data-emoji="LOVE">❤️</span>
                        <span class="emoji" data-emoji="WOW">😲</span>
                        <span class="emoji" data-emoji="SAD">😔</span>
                        <span class="emoji" data-emoji="ANGRY">😡</span>
                    </div>
                </div>
            `;

            chatbody.innerHTML = content;

            function scrollToBottom() {
                const messageArea = document.getElementById('messageArea');
                messageArea.scrollTop = messageArea.scrollHeight;
            }

            fetch(`http://localhost:8080/api/messages?senderId=${senderId}&receiverId=${userId}&page=0&size=1000`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                },
            })
                .then(res => {
                    if (!res.ok) {
                        throw new Error(`HTTP error! Status: ${res.status}`);
                    }
                    return res.json();
                })
                .then(data => {
                    data.content.forEach(message => {
                        if (message.sender_id == senderId) {
                            displayMyMessage(message);
                        } else {
                            displayMessage(message)
                        }
                    });
                    scrollToBottom();
                })
                .catch(err => console.error('Error:', err));

            socket.on('user-chat', (data) => {
                if (data.sender_id == senderId) {
                    displayMyMessage(data)
                } else {
                    displayMessage(data)
                }
                scrollToBottom();

                socket.emit("message-seen", {
                    messageId: data.id,
                    viewerId: senderId,
                    senderId: data.sender_id,
                    status: true
                });
            });

            socket.on('notification', (data) => {
                console.log(data);
                if (data.userId == senderId) {
                    showNotification(data.title, data.message, data.mediaUrl);

                    const listItem = document.createElement('li');
                    listItem.classList.add('list-group-item', 'custom-checkbox-list-wrapper');

                    // Thêm nội dung vào phần tử li
                    listItem.innerHTML = `
                        <div class="row">
                            <div class="col-auto position-static">
                                <div class="d-flex align-items-center">
                                    <div class="avatar avatar-sm avatar-circle">
                                        <!-- Kiểm tra avatarUrl có tồn tại không -->
                                        ${data.avatarUrl ?
                            `<img class="avatar-img" src="${data.avatarUrl}" alt="Avatar">` :
                            `<div class="d-flex justify-content-center align-items-center rounded-circle mr-2" 
                                                style="background-color: #2172dd; color: #fff; width: 40px; height: 40px; font-size: 14px; font-weight: bold; flex-shrink: 0;">
                                                <span>${data.fullname ? data.fullname.charAt(0).toUpperCase() : 'N'}</span>
                                            </div>`
                        }
                                    </div>
                                </div>
                            </div>
                            <div class="col ml-n3">
                                <span class="card-title h5">${data.fullname}</span>
                                <p class="card-text font-size-sm">${data.message}</p>
                            </div>
                            <small class="col-auto text-muted text-cap">${new Date(data.notificationTime).toLocaleString()}</small>
                        </div>
                    <a class="stretched-link" href="#"></a>
        `;

                    list_notification.prepend(listItem);
                }
            });

            function showNotification(title, message, imageUrl) {
                document.getElementById('notificationTitle').innerText = title;
                document.getElementById('notificationMessage').innerText = message;


                var notificationImage = document.getElementById('notificationImage');
                if (imageUrl) {
                    notificationImage.src = imageUrl;
                    notificationImage.style.display = 'block';
                } else {
                    notificationImage.style.display = 'none';
                }

                // Hiển thị thông báo
                var notification = document.getElementById('notification');
                notification.style.display = 'block';

                const audio = new Audio('/assets/img/notification.mp3');
                audio.play();

                setTimeout(function () {
                    notification.style.display = 'none';
                    audio.pause();
                }, 5000);
            }


            socket.on("user-chat-update", (updatedMessage) => {
                const reactionIcons = {
                    LIKE: '👍',
                    HAHA: '😆',
                    LOVE: '❤️',
                    WOW: '😲',
                    SAD: '😔',
                    ANGRY: '😡'
                };

                const createReactionDisplay = (reaction) => {
                    return reaction && reactionIcons[reaction]
                        ? `<div class="reaction-display">${reactionIcons[reaction]}</div>`
                        : '';
                };

                const createMessageHTML = (message, className, idPrefix) => {
                    const imageElement = message.mediaUrl
                        ? `<img src="${message.mediaUrl}" alt="User Image" class="message-image mt-3" />`
                        : '';
                    const reactionDisplay = createReactionDisplay(message.reaction);

                    return `
                        <div class='${className}' id="${idPrefix}-${message.id}" data-message-id="${message.id}">
                            <div class='avatar_show tooltipped' data-position='right' data-tooltip='${message.fullname}'>
                                ${message.fullname.charAt(0).toLocaleUpperCase()}
                            </div>
                            <div class='message'>
                                ${imageElement}
                                ${message.content}
                                <div class="message-time">${message.send_time.substring(11, 19)}</div>
                                ${reactionDisplay}  
                            </div>
                        </div>
        `;
                };

                const isSender = updatedMessage.sender_id == senderId;
                const idPrefix = isSender ? 'myMessage' : 'incomingMessage';
                const messageElement = document.getElementById(`${idPrefix}-${updatedMessage.id}`);

                if (messageElement) {
                    const className = isSender ? 'me' : 'incoming';
                    messageElement.innerHTML = createMessageHTML(updatedMessage, className, idPrefix);
                } else {
                    console.warn(`Message element with ID ${idPrefix}-${updatedMessage.id} not found.`);
                }
            });


            const seenUsers = document.querySelector('#seen-users');

            socket.on("user-seen", (data) => {

                seenUsers.innerHTML = '';
                Object.entries(data).forEach(([key, value]) => {
                    if (key != senderId) {
                        const userItem = document.createElement('div');
                        userItem.style.display = 'flex';
                        userItem.style.justifyContent = 'flex-end';
                        userItem.style.paddingLeft = '100px';
                        userItem.style.paddingRight = '100px';

                        userItem.innerHTML = `<div class="seenIncoming" style="display: flex; justify-content: flex-start; align-items: center;">
                            <div class="avatar1-text" style="background-color: #2172dd; color: #fafafa; display: flex; justify-content: center; align-items: center; 
                                    width: 20px; height: 20px; font-size: 8px; font-weight: bold; border-radius: 50%; margin-right: 10px;">
                                <span>${value.substring(0, 1).toUpperCase()}</span>
                            </div>
                          </div>`;
                        seenUsers.appendChild(userItem);
                    }
                });
            });

            const typingStatus = document.querySelector('#typing-status');

            let typingTimeout;

            chatMess.addEventListener('input', () => {
                clearTimeout(typingTimeout);
                socket.emit('userTyping', senderId);

                typingTimeout = setTimeout(() => {
                    socket.emit('userStoppedTyping', senderId);
                }, 3000);
            });

            socket.on("typingUsers", (usersTyping) => {
                const otherUsersTyping = Object.keys(usersTyping).filter(user => user !== senderId);
                if (otherUsersTyping.length > 0) {
                    console.log("1 " + otherUsersTyping);
                    scrollToBottom();
                    typingStatus.innerHTML = `
                    <div style="display: flex; align-items: center;">
                        ${otherUsersTyping.map(user => `
                            <div class="avatar1-text" style="background-color: #2172dd; color: #fafafa; display: flex; justify-content: center; align-items: center; 
                                width: 20px; height: 20px; font-size: 8px; font-weight: bold; border-radius: 50%; margin-right: 10px;">
                                <span>${user.substring(0, 1).toUpperCase()}</span>
                            </div>
                        `).join('')}
                        <img src="/assets/img/typing.gif" alt="Typing..." style="width: 24px; height: 24px;" />
                    </div>
                     `;
                } else {
                    typingStatus.textContent = '';
                    scrollToBottom();
                }
            });

            const MAX_FILE_SIZE = 5 * 1024 * 1024;
            submit.addEventListener('click', () => {
                const message = chatMess.value.trim();
                const file = fileInput.files[0];
                let fileBase64 = null;

                if (file) {
                    if (file.size > MAX_FILE_SIZE) {
                        alert("File is too large. Please upload a smaller file.");
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = function (event) {
                        fileBase64 = event.target.result;
                        sendMessage(message, fileBase64);
                    };
                    reader.readAsDataURL(file);
                } else {
                    sendMessage(message, fileBase64);
                }

                function sendMessage(message, fileBase64) {
                    const data = {
                        sender: senderId,
                        receiver: userId,
                        message: message,
                        file: fileBase64 ?? null
                    }

                    if (message) {
                        socket.emit('send-message', data);
                        chatMess.value = '';
                        if (fileInput) {
                            fileInput.value = '';
                        }
                    }
                }
            })

            function displayMyMessage(message) {
                let imageElement = '';
                if (message.mediaUrl) {
                    imageElement = `<img src="${message.mediaUrl}" alt="User Image" class="message-image mt-3" />`;
                }

                const reactionIcons = {
                    LIKE: '👍',
                    HAHA: '😆',
                    LOVE: '❤️',
                    WOW: '😲',
                    SAD: '😔',
                    ANGRY: '😡'
                };

                let reactionDisplay = '';
                if (message.reaction && reactionIcons[message.reaction]) {
                    reactionDisplay = `<div class="reaction-display">${reactionIcons[message.reaction]}</div>`;
                }

                var div = `
                    <div class='me' id="myMessage-${message.id}" data-message-id="${message.id}">
                        <div class='avatar_show tooltipped' data-position='right' data-tooltip='${message.fullname}'>
                            ${message.fullname.charAt(0).toLocaleUpperCase()}
                        </div>
                        <div class='message'>
                            ${imageElement}
                            ${message.content}
                            <div class="message-time">${message.send_time.substring(11, 19)}</div>
                            ${reactionDisplay}
                        </div>
                    </div>
                `;
                $("#messageArea").append(div);
            }

            function displayMessage(message) {
                console.log(message);

                let imageElement = '';
                if (message.mediaUrl) {
                    imageElement = `<img src="${message.mediaUrl}" alt="User Image" class="message-image mt-3" />`;
                }

                const reactionIcons = {
                    LIKE: '👍',
                    HAHA: '😆',
                    LOVE: '❤️',
                    WOW: '😲',
                    SAD: '😔',
                    ANGRY: '😡'
                };

                let reactionDisplay = '';
                if (message.reaction && reactionIcons[message.reaction]) {
                    reactionDisplay = `<div class="reaction-display">${reactionIcons[message.reaction]}</div>`;
                }

                var div = `
                    <div class='incoming' id="incomingMessage-${message.id}" data-message-id="${message.id}">
                        <div class='avatar_show tooltipped' data-position='right' data-tooltip='${message.fullname}'>
                            ${message.fullname.charAt(0).toLocaleUpperCase()}
                        </div>
                        <div class='message'>
                            ${imageElement}
                            ${message.content}
                            <div class="message-time">${message.send_time.substring(11, 19)}</div>
                            ${reactionDisplay} <!-- Hiển thị reaction -->
                        </div>
                    </div>  
                `;

                $("#messageArea").append(div);

                const incomingMessage = document.querySelector(`#incomingMessage-${message.id}`);
                incomingMessage.addEventListener('click', function (event) {
                    openEmojiPopup(event, message.id);
                });

                function openEmojiPopup(event, id) {
                    const emojiPopup = document.getElementById('emojiPopup');
                    const rect = event.currentTarget.getBoundingClientRect();

                    emojiPopup.style.top = `${rect.bottom + window.scrollY - 190}px`;
                    emojiPopup.style.left = `${rect.left + window.scrollX - 260}px`;

                    emojiPopup.style.display = 'block';

                    document.querySelectorAll('.emoji').forEach(function (emoji) {
                        emoji.replaceWith(emoji.cloneNode(true));
                    });

                    document.querySelectorAll('.emoji').forEach(function (emoji) {
                        emoji.addEventListener('click', function (event) {
                            selectEmoji(event, id);
                        });
                    });
                }
            }

            function selectEmoji(event, id) {
                const selectedEmoji = event.target.getAttribute('data-emoji');

                console.log(selectedEmoji);

                const data = {
                    messageId: id,
                    sender: senderId,
                    receiver: userId,
                    icon: selectedEmoji
                }

                socket.emit("insert-icon", data);

                const emojiPopup = document.getElementById('emojiPopup');
                emojiPopup.style.display = 'none';
            }

            document.addEventListener('click', function (event) {
                const emojiPopup = document.getElementById('emojiPopup');
                if (!emojiPopup.contains(event.target) && !event.target.closest('.incoming')) {
                    emojiPopup.style.display = 'none';
                }
            });
        }
        document.getElementById("logoutLink").addEventListener("click", function () {
            window.location.replace("/web-server/login");
        });


        $(document).ready(function () {
            var table = $('#managerTable').DataTable({
                dom: '<"row d-flex justify-content-between align-items-center"<"col-sm-6 d-flex align-items-center"f><"col-sm-6 d-flex justify-content-end"B>>' +
                    '<"row"<"col-sm-12"tr>>' +
                    '<"row d-flex justify-content-between align-items-center"<"col-sm-6"i><"col-sm-6 d-flex justify-content-end"p>>',
                paging: true,
                searching: true,
                ordering: true,
                order: [],
                pageLength: 5,
                columnDefs: [
                    {
                        targets: [7],
                        orderable: false
                    }
                ],
                language: {
                    search: "",
                    searchPlaceholder: "Search managers",
                    paginate: {
                        previous: "Prev",
                    },

                }
            });

            $('#selectAll').on('click', function () {
                var rows = table.rows({ 'search': 'applied' }).nodes();
                $('input[type="checkbox"]', rows).prop('checked', this.checked);
            });

        });
    </script>

</body>

</html>
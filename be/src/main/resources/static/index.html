<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat App</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.0/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
        }

        #messages {
            border: 1px solid #ccc;
            height: 300px;
            overflow-y: scroll;
            margin-bottom: 20px;
        }

        .message {
            padding: 5px;
            border-bottom: 1px solid #eee;
        }

        .file-preview {
            max-width: 100px;
        }
    </style>
</head>
<body>
    <h1>Chat Application</h1>
    <div id="messages"></div>
    <input type="text" id="messageInput" placeholder="Enter your message" />
    <input type="number" id="yourId" placeholder="Enter your Id" />
    
    <div class="input-container">
        <label>
            <input type="radio" name="messageType" value="private" checked> Private Message
        </label>
        <label>
            <input type="radio" name="messageType" value="group"> Group Message
        </label>
    </div>
    <input type="file" id="fileInput" />
    <button id="sendButton">Send</button>

    <h2>Notifications</h2>
    <div id="notifications" style="border: 1px solid #ccc; height: 100px; overflow-y: scroll; margin-bottom: 20px;"></div>

    <script>
        let stompClient = null;

        function connect() {
            const socket = new SockJS('http://localhost:8080/ws-message');
            stompClient = Stomp.over(socket);
            stompClient.connect({}, function (frame) {

                const userId = 1;
                const groupId = 1;

                console.log('Connected: ' + frame);
                stompClient.subscribe('/topic/private/' + userId, function (messageOutput) {
                    showMessage(JSON.parse(messageOutput.body), "private");
                });
                stompClient.subscribe('/topic/group/' + groupId, function (messageOutput) {
                    showMessage(JSON.parse(messageOutput.body), "group");
                });
                stompClient.subscribe('/topic/notification/' + 2, function (notification) {
                    showNotification(JSON.parse(notification.body));
                });
            });
        }

        function showMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            messageDiv.textContent = message.content;

            // Nếu có URL file, hiển thị hình ảnh hoặc file
            if (message.mediaUrl) {
                const mediaElement = document.createElement('img');
                mediaElement.src = message.mediaUrl;
                mediaElement.className = 'file-preview';
                messageDiv.appendChild(mediaElement);
            } else if (message.file) {
                const fileLink = document.createElement('a');
                fileLink.href = message.file; // File được giải mã từ base64
                fileLink.download = 'file'; // Tải file về
                fileLink.textContent = 'Download File';
                messageDiv.appendChild(fileLink);
            }

            document.getElementById('messages').appendChild(messageDiv);
            document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
        }

        function showNotification(notificationBody) {
            const notificationDiv = document.createElement('div');
            notificationDiv.className = 'notification';
            notificationDiv.textContent = notificationBody;
            document.getElementById('notifications').appendChild(notificationDiv);
            document.getElementById('notifications').scrollTop = document.getElementById('notifications').scrollHeight;
        }

        document.getElementById('sendButton').addEventListener('click', function () {
            const messageInput = document.getElementById('messageInput').value;
            const messageType = document.querySelector('input[name="messageType"]:checked').value;
            const fileInput = document.getElementById('fileInput');
            const files = fileInput.files;

            const message = {
                content: messageInput,
                userSendId: 1,
                status: "SENT"
            };

            if (messageType === "private") {
                message.userIdReceived = 2;
                message.groupId = null;
            } else if (messageType === "group") {
                message.groupId = 1;
                message.userIdReceived = null;
            }

            // Nếu có file, chuyển đổi nó thành base64
            if (files.length > 0) {
                const file = files[0];
                const reader = new FileReader();

                reader.onloadend = function () {
                    // Khi đọc file xong, gửi base64 của file qua WebSocket
                    const base64File = reader.result.split(',')[1];  // Tách bỏ phần đầu của base64
                    message.file = base64File;  // Thêm file base64 vào tin nhắn

                    stompClient.send("/app/sendMessage", {}, JSON.stringify(message));
                };

                reader.readAsDataURL(file);  // Đọc file dưới dạng base64
            } else {
                // Nếu không có file, chỉ gửi tin nhắn
                stompClient.send("/app/sendMessage", {}, JSON.stringify(message));
            }
        });

        window.onload = connect;
    </script>
</body>
</html>
